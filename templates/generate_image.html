{% extends "base.html" %}

{% block title %}T·∫°o ·∫£nh AI - FazzyTool{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex align-items-center mb-4">
            <i class="fas fa-image fa-2x text-primary me-3"></i>
            <div>
                <h2 class="text-white mb-0">T·∫°o ·∫£nh AI</h2>
                <p class="text-white-50 mb-0">Sinh ·∫£nh t·ª´ prompt b·∫±ng Freepik Pikaso</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Form t·∫°o ·∫£nh -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>Nh·∫≠p th√¥ng tin
                </h5>
            </div>
            <div class="card-body">
                <form id="imageForm">
                    <div class="mb-3">
                        <label for="prompt" class="form-label">Prompt (ti·∫øng Anh) <span class="text-danger">*</span></label>
                        <textarea 
                            class="form-control" 
                            id="prompt" 
                            rows="4" 
                            placeholder="M√¥ t·∫£ chi ti·∫øt ·∫£nh b·∫°n mu·ªën t·∫°o..."
                            required></textarea>
                        <div class="form-text">
                            <i class="fas fa-lightbulb me-1"></i>
                            M·∫πo: M√¥ t·∫£ c√†ng chi ti·∫øt, k·∫øt qu·∫£ c√†ng ch√≠nh x√°c
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="numImages" class="form-label">S·ªë l∆∞·ª£ng ·∫£nh sinh ra</label>
                            <select class="form-control" id="numImages">
                                <option value="1">1 ·∫£nh</option>
                                <option value="2">2 ·∫£nh</option>
                                <option value="3">3 ·∫£nh</option>
                                <option value="4" selected>4 ·∫£nh (khuy·∫øn ngh·ªã)</option>
                                <option value="5">5 ·∫£nh</option>
                                <option value="6">6 ·∫£nh</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="downloadCount" class="form-label">S·ªë l∆∞·ª£ng ·∫£nh t·∫£i v·ªÅ</label>
                            <select class="form-control" id="downloadCount">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="1">1 ·∫£nh</option>
                                <option value="2" selected>2 ·∫£nh</option>
                                <option value="3">3 ·∫£nh</option>
                                <option value="4">4 ·∫£nh</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="filenamePrefix" class="form-label">Ti·ªÅn t·ªë t√™n file (t√πy ch·ªçn)</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="filenamePrefix" 
                            placeholder="V√≠ d·ª•: cat_cute">
                        <div class="form-text">ƒê·ªÉ tr·ªëng s·∫Ω t·ª± ƒë·ªông ƒë·∫∑t t√™n theo timestamp</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>‚ö†Ô∏è L∆ØU √ù QUAN TR·ªåNG:</strong><br>
                            ‚Ä¢ Ch·ªâ click "T·∫°o ·∫£nh" <strong>M·ªòT L·∫¶N</strong><br>
                            ‚Ä¢ Chrome s·∫Ω t·ª± ƒë·ªông m·ªü ƒë·ªÉ x·ª≠ l√Ω ·∫£nh<br>
                            ‚Ä¢ <strong>KH√îNG click nhi·ªÅu l·∫ßn</strong> ƒë·ªÉ tr√°nh m·ªü nhi·ªÅu browser<br>
                            ‚Ä¢ Ch·ªù ho√†n th√†nh tr∆∞·ªõc khi th·ª±c hi·ªán thao t√°c m·ªõi
                        </div>
                        
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>‚ùó L·ªñI TH∆Ø·ªúNG G·∫∂P:</strong><br>
                            ‚Ä¢ N·∫øu Chrome m·ªü l√™n r·ªìi t·ª± ƒë·ªông ƒë√≥ng: <strong>Cookie c·ªßa b·∫°n ƒë√£ h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá</strong><br>
                            ‚Ä¢ C·∫≠p nh·∫≠t cookie m·ªõi trong ph·∫ßn C√†i ƒë·∫∑t ho·∫∑c file cookie_template.txt<br>
                            ‚Ä¢ ƒê·∫£m b·∫£o ƒë√£ ƒëƒÉng nh·∫≠p Freepik v√† c√≥ ƒë·ªß credit ƒë·ªÉ t·∫°o ·∫£nh
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" id="clearBtn">
                            <i class="fas fa-eraser me-1"></i>X√≥a
                        </button>
                        <button type="submit" class="btn btn-primary" id="generateBtn">
                            <i class="fas fa-play me-1"></i>T·∫°o ·∫£nh
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Tr·∫°ng th√°i v√† k·∫øt qu·∫£ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Tr·∫°ng th√°i
                </h5>
            </div>
            <div class="card-body">
                <div id="statusSection" style="display: none;">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Ti·∫øn tr√¨nh</small>
                            <small class="text-muted" id="progressText">0%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info" id="statusMessage">
                        <i class="fas fa-spinner fa-spin me-2"></i>ƒêang kh·ªüi t·∫°o...
                    </div>
                </div>
                
                <div id="resultSection" style="display: none;">
                    <h6>K·∫øt qu·∫£:</h6>
                    <div id="resultImages" class="row g-2">
                        <!-- Images will be displayed here -->
                    </div>
                </div>
                
                <!-- H∆∞·ªõng d·∫´n -->
                <div id="instructionSection">
                    <h6>H∆∞·ªõng d·∫´n:</h6>
                    <ol class="small">
                        <li>Nh·∫≠p prompt m√¥ t·∫£ ·∫£nh (ti·∫øng Anh)</li>
                        <li>Ch·ªçn s·ªë l∆∞·ª£ng ·∫£nh sinh ra</li>
                        <li>Ch·ªçn s·ªë l∆∞·ª£ng ·∫£nh mu·ªën t·∫£i v·ªÅ</li>
                        <li>Nh·∫•n "T·∫°o ·∫£nh" v√† ch·ªù k·∫øt qu·∫£</li>
                    </ol>
                    
                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            ƒê·∫£m b·∫£o ƒë√£ c·∫•u h√¨nh cookie Freepik trong m·ª•c C√†i ƒë·∫∑t
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Prompt examples -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>V√≠ d·ª• prompt
                </h6>
            </div>
            <div class="card-body">
                <div class="prompt-examples">
                    <div class="mb-2">
                        <button class="btn btn-outline-primary btn-sm w-100 text-start example-btn" 
                                data-prompt="A cute orange cat sleeping on a windowsill with sunlight streaming through">
                            M√®o cam d·ªÖ th∆∞∆°ng ng·ªß tr√™n c·ª≠a s·ªï
                        </button>
                    </div>
                    <div class="mb-2">
                        <button class="btn btn-outline-primary btn-sm w-100 text-start example-btn" 
                                data-prompt="Beautiful sunset landscape with mountains and lake reflection">
                            Phong c·∫£nh ho√†ng h√¥n v·ªõi n√∫i v√† h·ªì
                        </button>
                    </div>
                    <div class="mb-2">
                        <button class="btn btn-outline-primary btn-sm w-100 text-start example-btn" 
                                data-prompt="Modern minimalist living room with natural light and plants">
                            Ph√≤ng kh√°ch t·ªëi gi·∫£n hi·ªán ƒë·∫°i
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTaskId = null;
    let statusCheckInterval = null;
    let lastClickTime = 0;
    const DEBOUNCE_TIME = 2000; // 2 gi√¢y debounce
    
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('imageForm');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exampleBtns = document.querySelectorAll('.example-btn');
        
        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            generateImage();
        });
        
        // Handle clear button
        clearBtn.addEventListener('click', function() {
            form.reset();
            hideStatus();
        });
        
        // Handle example prompts
        exampleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('prompt').value = this.dataset.prompt;
            });
        });
        
        // Check for prompt parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const promptParam = urlParams.get('prompt');
        if (promptParam) {
            document.getElementById('prompt').value = promptParam;
        }
    });
    
    function generateImage() {
        const generateBtn = document.getElementById('generateBtn');
        const now = Date.now();
        
        // Debounce check - ngƒÉn click qu√° nhanh
        if (now - lastClickTime < DEBOUNCE_TIME) {
            console.log('‚ö†Ô∏è Click qu√° nhanh, b·ªè qua');
            alert('‚ö†Ô∏è CLICK QU√Å NHANH!\n\nVui l√≤ng ch·ªù √≠t nh·∫•t 2 gi√¢y gi·ªØa c√°c l·∫ßn click.');
            return;
        }
        lastClickTime = now;
        
        // NGAY L·∫¨P T·ª®C disable button ƒë·ªÉ ngƒÉn double-click
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang kh·ªüi t·∫°o...';
        
        // NgƒÉn multiple clicks
        if (currentTaskId) {
            alert('‚ö†Ô∏è ƒê√É C√ì TASK ƒêANG CH·∫†Y!\n\n' +
                  '‚Ä¢ Ch·ªâ ƒë∆∞·ª£c t·∫°o ·∫£nh 1 l·∫ßn trong 1 th·ªùi ƒëi·ªÉm\n' +
                  '‚Ä¢ Chrome ƒëang x·ª≠ l√Ω task hi·ªán t·∫°i\n' +
                  '‚Ä¢ Vui l√≤ng ch·ªù ho√†n th√†nh tr∆∞·ªõc khi th·ª±c hi·ªán m·ªõi\n\n' +
                  'Task ID: ' + currentTaskId);
            resetForm(); // Reset button n·∫øu c√≥ l·ªói
            return;
        }
        
        const form = document.getElementById('imageForm');
        const formData = new FormData(form);
        
        const data = {
            prompt: document.getElementById('prompt').value.trim(),
            num_images: parseInt(document.getElementById('numImages').value),
            download_count: document.getElementById('downloadCount').value ? parseInt(document.getElementById('downloadCount').value) : null,
            filename_prefix: document.getElementById('filenamePrefix').value.trim() || null,
            // Browser lu√¥n visible n√™n kh√¥ng c·∫ßn g·ª≠i show_browser
        };
        
        if (!data.prompt) {
            alert('Vui l√≤ng nh·∫≠p prompt!');
            return;
        }
        
        console.log('üöÄ B·∫Øt ƒë·∫ßu t·∫°o ·∫£nh:', data);
        
        // Show loading state
        showStatus();
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫°o...';
        
        // Start image generation
        fetch('/api/generate-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            console.log('üì° API Response:', result);
            
            if (result.error || !result.success) {
                // X·ª≠ l√Ω t·ª´ ch·ªëi t·ª´ backend
                if (result.error_code === 'TASK_RUNNING') {
                    console.log('‚ùå Backend t·ª´ ch·ªëi: C√≥ task ƒëang ch·∫°y');
                    alert('‚ö†Ô∏è BACKEND T·ª™ CH·ªêI REQUEST!\n\n' +
                          '‚Ä¢ Server ph√°t hi·ªán c√≥ task kh√°c ƒëang ch·∫°y\n' +
                          '‚Ä¢ Chrome browser ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng\n' +
                          '‚Ä¢ Vui l√≤ng ch·ªù task hi·ªán t·∫°i ho√†n th√†nh\n\n' +
                          'H√£y ki·ªÉm tra Chrome c√≥ ƒëang m·ªü FreePik kh√¥ng?');
                }
                throw new Error(result.message || result.error || 'C√≥ l·ªói x·∫£y ra');
            }
            
            currentTaskId = result.task_id;
            console.log('üÜî Task ID:', currentTaskId);
            checkTaskStatus();
        })
        .catch(error => {
            console.error('‚ùå Error:', error);
            showError(error.message);
            resetForm();
        });
    }
    
    function checkTaskStatus() {
        if (!currentTaskId) return;
        
        statusCheckInterval = setInterval(() => {
            fetch(`/api/task-status/${currentTaskId}`)
                .then(response => response.json())
                .then(status => {
                    updateProgress(status.progress || 0, status.message || 'ƒêang x·ª≠ l√Ω...');
                    
                    if (status.status === 'completed') {
                        clearInterval(statusCheckInterval);
                        showResults(status.results || []);
                        resetForm();
                    } else if (status.status === 'error') {
                        clearInterval(statusCheckInterval);
                        showError(status.message || 'C√≥ l·ªói x·∫£y ra');
                        resetForm();
                    }
                })
                .catch(error => {
                    console.error('Status check error:', error);
                });
        }, 2000);
    }
    
    function showStatus() {
        document.getElementById('instructionSection').style.display = 'none';
        document.getElementById('statusSection').style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';
    }
    
    function hideStatus() {
        document.getElementById('instructionSection').style.display = 'block';
        document.getElementById('statusSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'none';
    }
    
    function updateProgress(progress, message) {
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = progress + '%';
        document.getElementById('statusMessage').innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${message}`;
    }
    
    function showResults(results) {
        const container = document.getElementById('resultImages');
        container.innerHTML = '';
        
        if (results && results.length > 0) {
            results.forEach(filename => {
                const div = document.createElement('div');
                div.className = 'col-6 mb-2';
                div.innerHTML = `
                    <div class="position-relative">
                        <img src="/output/${filename}" class="img-fluid rounded" style="width: 100%; height: 80px; object-fit: cover;">
                        <div class="position-absolute top-0 end-0 p-1">
                            <a href="/output/${filename}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('statusMessage').innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>Ho√†n th√†nh! ƒê√£ t·∫°o ${results.length} ·∫£nh`;
        } else {
            document.getElementById('statusMessage').innerHTML = `<i class="fas fa-exclamation-triangle text-warning me-2"></i>Kh√¥ng c√≥ ·∫£nh n√†o ƒë∆∞·ª£c t·∫°o`;
        }
    }
    
    function showError(message) {
        document.getElementById('statusMessage').innerHTML = `<i class="fas fa-exclamation-circle text-danger me-2"></i>L·ªói: ${message}`;
        document.getElementById('statusMessage').className = 'alert alert-danger';
    }
    
    function resetForm() {
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').innerHTML = '<i class="fas fa-play me-1"></i>T·∫°o ·∫£nh';
        currentTaskId = null;
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }
    }
</script>
{% endblock %}
</rewritten_file>