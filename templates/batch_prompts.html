{% extends "base.html" %}

{% block title %}Tạo ảnh hàng loạt từ file prompt - FazzyTool{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex align-items-center mb-4">
            <i class="fas fa-file-image fa-2x text-warning me-3"></i>
            <div>
                <h2 class="text-white mb-0">Tạo ảnh hàng loạt từ file prompt</h2>
                <p class="text-white-50 mb-0">Upload file .txt chứa các prompt có sẵn và tạo ảnh hàng loạt</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Form upload file -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>Upload file prompt
                </h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="promptFile" class="form-label">Chọn file .txt <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="promptFile" accept=".txt" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            File .txt với format: "Prompt 1", "Prompt 2", "Prompt 3"... (xem ví dụ bên phải)
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>⚠️ LƯU Ý QUAN TRỌNG:</strong><br>
                            • Chỉ click "Bắt đầu tạo ảnh" <strong>MỘT LẦN</strong><br>
                            • Chrome sẽ tự động mở để xử lý ảnh<br>
                            • <strong>KHÔNG click nhiều lần</strong> để tránh mở nhiều browser<br>
                            • Chờ hoàn thành trước khi thực hiện thao tác mới
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" id="clearBtn">
                            <i class="fas fa-eraser me-1"></i>Xóa file
                        </button>
                        <button type="submit" class="btn btn-info me-md-2" id="previewBtn">
                            <i class="fas fa-eye me-1"></i>Xem trước
                        </button>
                        <button type="button" class="btn btn-warning" id="generateBtn" disabled>
                            <i class="fas fa-play me-1"></i>Bắt đầu tạo ảnh
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Preview prompts -->
        <div class="card mt-3" id="previewCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Danh sách prompt đã phân tích
                </h5>
            </div>
            <div class="card-body">
                <div id="promptsList">
                    <!-- Parsed prompts will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Log real-time -->
        <div class="card mt-3" id="logCard" style="display: none;">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-terminal me-2"></i>Log xử lý
                    </h5>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearLogBtn">
                        <i class="fas fa-trash me-1"></i>Xóa log
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="logContainer" class="bg-dark text-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                    <!-- Logs will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Kết quả -->
        <div class="card mt-3" id="resultCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-images me-2"></i>Kết quả tạo ảnh
                </h5>
            </div>
            <div class="card-body">
                <div id="resultSummary" class="mb-3">
                    <!-- Summary will appear here -->
                </div>
                <div id="resultGallery" class="row">
                    <!-- Images will appear here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Trạng thái -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Trạng thái
                </h5>
            </div>
            <div class="card-body">
                <div id="statusSection" style="display: none;">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Tiến trình chung</small>
                            <small class="text-muted" id="progressText">0%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Prompt hiện tại:</small>
                        <div id="currentPrompt" class="fw-bold text-truncate">-</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Tiến độ:</small>
                        <div id="promptProgress">0 / 0 prompt</div>
                    </div>
                    
                    <div class="alert alert-info" id="statusMessage">
                        <i class="fas fa-spinner fa-spin me-2"></i>Đang khởi tạo...
                    </div>
                </div>
                
                <!-- Hướng dẫn -->
                <div id="instructionSection">
                    <h6>Hướng dẫn:</h6>
                    <ol class="small">
                        <li>Tạo file .txt chứa các prompt</li>
                        <li>Upload file và nhấn "Xem trước"</li>
                        <li>Kiểm tra danh sách prompt đã phân tích</li>
                        <li>Nhấn "Bắt đầu tạo ảnh" và chờ xử lý</li>
                        <li>Theo dõi log để biết tiến trình</li>
                    </ol>
                    
                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Đảm bảo đã cấu hình cookie Freepik trong mục Cài đặt
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Thống kê file -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Thống kê
                </h6>
            </div>
            <div class="card-body">
                <div id="statsSection" style="display: none;">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="h5 mb-1" id="totalPrompts">0</div>
                                <small class="text-muted">Prompt</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="h5 mb-1" id="totalImages">0</div>
                            <small class="text-muted">Ảnh tạo</small>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <div class="h6 mb-1" id="estimatedTime">0 phút</div>
                        <small class="text-muted">Thời gian ước tính</small>
                    </div>
                </div>
                <div id="noStatsSection">
                    <p class="text-muted small text-center">Chưa có dữ liệu</p>
                </div>
            </div>
        </div>
        
        <!-- Format file mẫu -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-file-text me-2"></i>Format file mẫu
                </h6>
            </div>
            <div class="card-body">
                <div class="bg-light p-3 rounded">
                    <code style="font-size: 0.8em;">
                        Prompt 1<br>
                        A cute cat sitting in a garden<br>
                        <br>
                        Prompt 2<br>
                        Beautiful sunset over the ocean<br>
                        <br>
                        Prompt 3<br>
                        Futuristic robot in cyberpunk city<br>
                        <br>
                        Prompt 4<br>
                        Modern living room with minimalist design
                    </code>
                </div>
                <div class="mt-2">
                    <button type="button" class="btn btn-outline-primary btn-sm w-100" id="downloadSampleBtn">
                        <i class="fas fa-download me-1"></i>Tải file mẫu
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTaskId = null;
    let statusCheckInterval = null;
    let isProcessing = false;
    let parsedPrompts = [];
    let fileContent = '';
    let lastClickTime = 0;
    const DEBOUNCE_TIME = 2000; // 2 giây debounce

    // Upload file và preview
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('promptFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Vui lòng chọn file');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/api/upload-prompt-file', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                fileContent = data.file_content || '';
                parsedPrompts = data.parsed_prompts || [];
                
                if (parsedPrompts.length > 0) {
                showPreview(data);
                updateStats(data);
                document.getElementById('generateBtn').disabled = false;
                } else {
                    throw new Error('Không tìm thấy prompt nào trong file');
                }
            } else {
                throw new Error(data.message || data.error || 'Lỗi upload file');
            }
            
        } catch (error) {
            alert('Lỗi: ' + error.message);
        }
    });

    function showPreview(data) {
        const previewCard = document.getElementById('previewCard');
        const promptsList = document.getElementById('promptsList');
        
        previewCard.style.display = 'block';
        
        const totalPrompts = data.total_prompts || 0;
        const parsedPrompts = data.parsed_prompts || [];
        
        let html = `<div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Phân tích thành công!</h6>
            <p class="mb-0">Tìm thấy <strong>${totalPrompts}</strong> prompt hợp lệ</p>
        </div>`;
        
        if (parsedPrompts.length > 0) {
            html += '<div class="list-group">';
            parsedPrompts.forEach((prompt, index) => {
                const promptName = prompt.name || `Prompt ${index + 1}`;
                const promptContent = prompt.content || 'Không có nội dung';
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${promptName}</h6>
                            <small class="text-muted">4 ảnh</small>
                        </div>
                        <p class="mb-1">${promptContent}</p>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        promptsList.innerHTML = html;
    }

    function updateStats(data) {
        document.getElementById('noStatsSection').style.display = 'none';
        document.getElementById('statsSection').style.display = 'block';
        
        const totalPrompts = data.total_prompts || 0;
        const totalImages = totalPrompts * 4; // 4 ảnh mỗi prompt
        const estimatedMinutes = Math.ceil(totalPrompts * 3); // 3 phút per prompt
        
        document.getElementById('totalPrompts').textContent = totalPrompts;
        document.getElementById('totalImages').textContent = totalImages;
        document.getElementById('estimatedTime').textContent = estimatedMinutes + ' phút';
    }

    // Bắt đầu tạo ảnh
    document.getElementById('generateBtn').addEventListener('click', function() {
        generateBatchImages();
    });

    function generateBatchImages() {
        const generateBtn = document.getElementById('generateBtn');
        const now = Date.now();
        
        // Debounce check - ngăn click quá nhanh
        if (now - lastClickTime < DEBOUNCE_TIME) {
            console.log('⚠️ Click quá nhanh, bỏ qua');
            alert('⚠️ CLICK QUÁ NHANH!\n\nVui lòng chờ ít nhất 2 giây giữa các lần click.');
            return;
        }
        lastClickTime = now;
        
        // NGAY LẬP TỨC disable button để ngăn double-click
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang khởi tạo...';
        
        // Ngăn multiple clicks
        if (currentTaskId) {
            alert('⚠️ ĐÃ CÓ TASK ĐANG CHẠY!\n\n' +
                  '• Chỉ được tạo ảnh 1 lần trong 1 thời điểm\n' +
                  '• Chrome đang xử lý task hiện tại\n' +
                  '• Vui lòng chờ hoàn thành trước khi thực hiện mới\n\n' +
                  'Task ID: ' + currentTaskId);
            resetForm(); // Reset button nếu có lỗi
            return;
        }
        
        if (!fileContent) {
            alert('Vui lòng upload file trước');
            resetForm();
            return;
        }
        
        // Show loading state
            showProcessingUI();
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang tạo...';
            
        // Start batch process
        fetch('/api/batch-prompts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_content: fileContent
                })
        })
        .then(response => response.json())
        .then(result => {
            console.log('📡 API Response:', result);
            
            if (result.error || !result.success) {
                // Xử lý từ chối từ backend
                if (result.error_code === 'TASK_RUNNING') {
                    console.log('❌ Backend từ chối: Có task đang chạy');
                    alert('⚠️ BACKEND TỪ CHỐI REQUEST!\n\n' +
                          '• Server phát hiện có task khác đang chạy\n' +
                          '• Chrome browser đang được sử dụng\n' +
                          '• Vui lòng chờ task hiện tại hoàn thành\n\n' +
                          'Hãy kiểm tra Chrome có đang mở FreePik không?');
                }
                throw new Error(result.message || result.error || 'Có lỗi xảy ra');
            }
            
            currentTaskId = result.task_id;
            console.log('🆔 Task ID:', currentTaskId);
            startStatusChecking();
        })
        .catch(error => {
            console.error('❌ Error:', error);
            addLog(`❌ LỖI: ${error.message}`);
            document.getElementById('statusMessage').innerHTML = 
                `<i class="fas fa-exclamation-circle text-danger me-2"></i>Lỗi: ${error.message}`;
            resetForm();
        });
    }

    // Clear buttons
    document.getElementById('clearBtn').addEventListener('click', function() {
        document.getElementById('promptFile').value = '';
        document.getElementById('previewCard').style.display = 'none';
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('statsSection').style.display = 'none';
        document.getElementById('noStatsSection').style.display = 'block';
        fileContent = '';
        parsedPrompts = [];
        hideProcessingUI();
    });

    document.getElementById('clearLogBtn').addEventListener('click', function() {
        document.getElementById('logContainer').innerHTML = '';
    });

    // Download sample file
    document.getElementById('downloadSampleBtn').addEventListener('click', function() {
        const sampleContent = `Prompt 1
A cute cat sitting in a garden, watercolor style, soft lighting

Prompt 2
Beautiful sunset over the ocean, vibrant colors, peaceful atmosphere

Prompt 3
Futuristic robot in cyberpunk city, neon lights, high-tech environment

Prompt 4
Modern living room with minimalist design, clean lines, natural light

Prompt 5
Delicious Vietnamese pho bowl, traditional ingredients, appetizing presentation`;

        const blob = new Blob([sampleContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sample_prompts.txt';
        a.click();
        window.URL.revokeObjectURL(url);
    });

    function addLog(message) {
        const logContainer = document.getElementById('logContainer');
        const timestamp = new Date().toLocaleTimeString();
        const logDiv = document.createElement('div');
        logDiv.textContent = `[${timestamp}] ${message}`;
        logDiv.className = 'mb-1';
        
        // Color coding for different log types
        if (message.includes('✅')) {
            logDiv.className += ' text-success';
        } else if (message.includes('❌')) {
            logDiv.className += ' text-danger';
        } else if (message.includes('🔄')) {
            logDiv.className += ' text-info';
        } else if (message.includes('⏳')) {
            logDiv.className += ' text-warning';
        } else if (message.includes('🎉')) {
            logDiv.className += ' text-success fw-bold';
        }
        
        logContainer.appendChild(logDiv);
        
        // Auto scroll to bottom
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    function showProcessingUI() {
        document.getElementById('instructionSection').style.display = 'none';
        document.getElementById('statusSection').style.display = 'block';
        document.getElementById('logCard').style.display = 'block';
        document.getElementById('generateBtn').disabled = true;
        isProcessing = true;
        
        // Xóa logs cũ
        document.getElementById('logContainer').innerHTML = '';
        addLog("🚀 Bắt đầu tiến trình tạo ảnh hàng loạt...");
    }

    function hideProcessingUI() {
        document.getElementById('instructionSection').style.display = 'block';
        document.getElementById('statusSection').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;
        isProcessing = false;
    }

    function startStatusChecking() {
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
        }
        
        statusCheckInterval = setInterval(() => {
            if (!currentTaskId) return;
            
            fetch(`/api/task-status/${currentTaskId}`)
                .then(response => response.json())
                .then(data => {
                    updateUI(data);
                    
                    if (data.status === 'completed' || data.status === 'error') {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                        
                        if (data.status === 'completed') {
                            showResults(data);
                        } else {
                            // Hiển thị lỗi
                            document.getElementById('statusMessage').innerHTML = 
                                `<i class="fas fa-exclamation-circle text-danger me-2"></i>Lỗi: ${data.message}`;
                            document.getElementById('statusMessage').className = 'alert alert-danger';
                        }
                        
                        resetForm();
                }
                })
                .catch(error => {
                    console.error('Status check error:', error);
                });
        }, 2000);
    }

    function updateUI(data) {
        // Update progress bar
        const progress = data.progress || 0;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = progress + '%';
        
        // Update current prompt
        if (data.current_prompt) {
            document.getElementById('currentPrompt').textContent = data.current_prompt;
            document.getElementById('currentPrompt').title = data.current_prompt; // Tooltip for full text
        }
        
        // Update prompt progress
        if (data.completed_prompts !== undefined && data.total_prompts !== undefined) {
            document.getElementById('promptProgress').textContent = 
                data.completed_prompts + ' / ' + data.total_prompts + ' prompt';
        }
        
        // Update status message
        document.getElementById('statusMessage').innerHTML = 
            '<i class="fas fa-spinner fa-spin me-2"></i>' + (data.message || 'Đang xử lý...');
        
        // Update logs
        if (data.logs && data.logs.length > 0) {
            const logContainer = document.getElementById('logContainer');
            
            // Only add new logs
            const currentLogCount = logContainer.children.length;
            const newLogs = data.logs.slice(currentLogCount);
            
            newLogs.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.textContent = log;
                logDiv.className = 'mb-1';
                
                // Color coding for different log types
                if (log.includes('✅')) {
                    logDiv.className += ' text-success';
                } else if (log.includes('❌')) {
                    logDiv.className += ' text-danger';
                } else if (log.includes('🔄')) {
                    logDiv.className += ' text-info';
                } else if (log.includes('⏳')) {
                    logDiv.className += ' text-warning';
                } else if (log.includes('🎉')) {
                    logDiv.className += ' text-success fw-bold';
                }
                
                logContainer.appendChild(logDiv);
            });
            
            // Auto scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    }

    function showResults(data) {
        if (data.results && data.results.length > 0) {
            document.getElementById('resultCard').style.display = 'block';
            
            const totalImages = data.results.reduce((sum, result) => sum + result.files.length, 0);
            document.getElementById('resultSummary').innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>Hoàn thành!</h6>
                    <p class="mb-0">Đã tạo thành công <strong>${totalImages}</strong> ảnh từ <strong>${data.results.length}</strong> prompt.</p>
                </div>
            `;
            
            // Show gallery
            const gallery = document.getElementById('resultGallery');
            gallery.innerHTML = '';
            
            data.results.forEach((result, index) => {
                const promptDiv = document.createElement('div');
                promptDiv.className = 'col-12 mb-4';
                promptDiv.innerHTML = `
                    <h6>${result.prompt_name}</h6>
                    <p class="text-muted small">${result.prompt_content}</p>
                    <div class="row">
                        ${result.files.map(file => `
                            <div class="col-md-3 mb-2">
                                <div class="card">
                                    <img src="/output/${file.split('/').pop()}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="Generated image">
                                    <div class="card-body p-2">
                                        <small class="text-muted">${file.split('/').pop()}</small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                gallery.appendChild(promptDiv);
            });
        }
    }

    function resetForm() {
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').innerHTML = '<i class="fas fa-play me-1"></i>Bắt đầu tạo ảnh';
        currentTaskId = null;
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }
    }
</script>
{% endblock %} 