{% extends "base.html" %}

{% block title %}T·∫°o prompt AI - FazzyTool{% endblock %}

{% block extra_css %}
<style>
    .example-btn {
        transition: all 0.2s ease;
    }
    .example-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Prompt card styling */
    .prompt-card {
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        position: relative;
        overflow: hidden;
        margin-bottom: 12px;
        cursor: pointer;
    }
    
    .prompt-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border-color: #007bff;
    }
    
    .prompt-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(45deg, #007bff, #28a745);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .prompt-card:hover::before {
        opacity: 1;
    }
    
    .prompt-topic {
        color: #007bff;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }
    
    .prompt-topic::before {
        content: 'üéØ';
        margin-right: 6px;
    }
    
    .prompt-text {
        color: #6c757d;
        font-size: 0.8rem;
        line-height: 1.4;
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .prompt-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.7rem;
        color: #adb5bd;
        margin-bottom: 8px;
    }
    
    .prompt-actions {
        display: flex;
        gap: 6px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .prompt-card:hover .prompt-actions {
        opacity: 1;
    }
    
    .action-btn {
        padding: 4px 8px;
        border-radius: 6px;
        border: none;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
    }
    
    .btn-edit {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
    }
    
    .btn-copy {
        background: linear-gradient(45deg, #28a745, #1e7e34);
        color: white;
    }
    
    .btn-use {
        background: linear-gradient(45deg, #17a2b8, #138496);
        color: white;
    }
    
    /* Edit form styling */
    .edit-form {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        border-radius: 12px;
        padding: 16px;
        border: 2px solid #007bff;
        box-shadow: 0 4px 20px rgba(0,123,255,0.1);
    }
    
    .edit-form .form-label {
        color: #495057;
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .edit-form .form-control {
        border-radius: 8px;
        border: 1px solid #ced4da;
        transition: all 0.2s ease;
    }
    
    .edit-form .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .edit-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    
    .edit-actions .btn {
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .edit-actions .btn:hover {
        transform: translateY(-1px);
    }
    
    /* Recent prompts section */
    .recent-prompts-header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .recent-prompts-header h6 {
        margin: 0;
        font-weight: 600;
    }
    
    .refresh-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        border-radius: 6px;
        padding: 4px 8px;
        transition: all 0.2s ease;
    }
    
    .refresh-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(180deg);
    }
    
    .prompts-container {
        max-height: 500px;
        overflow-y: auto;
        padding: 8px;
    }
    
    .prompts-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .prompts-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .prompts-container::-webkit-scrollbar-thumb {
        background: #007bff;
        border-radius: 3px;
    }
    
    /* Empty state */
    .empty-prompts {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .empty-prompts i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    /* Loading animation */
    .loading-prompts {
        text-align: center;
        padding: 20px;
        color: #007bff;
    }
    
    .loading-prompts i {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .prompt-actions {
            opacity: 1;
        }
        
        .edit-actions {
            flex-direction: column;
        }
        
        .action-btn {
            font-size: 0.7rem;
            padding: 3px 6px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex align-items-center mb-4">
            <i class="fas fa-brain fa-2x text-success me-3"></i>
            <div>
                <h2 class="text-white mb-0">T·∫°o prompt AI</h2>
                <p class="text-white-50 mb-0">Sinh prompt t·ª± ƒë·ªông b·∫±ng Google Gemini AI</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <!-- Form t·∫°o prompt -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>Nh·∫≠p ch·ªß ƒë·ªÅ
                </h5>
            </div>
            <div class="card-body">
                <form id="promptForm">
                    <div class="mb-3">
                        <label for="topic" class="form-label">Ch·ªß ƒë·ªÅ (ti·∫øng Vi·ªát) <span class="text-danger">*</span></label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="topic" 
                            placeholder="V√≠ d·ª•: con m√®o d·ªÖ th∆∞∆°ng, phong c·∫£nh bi·ªÉn ƒë·∫πp..."
                            required>
                        <div class="form-text">
                            <i class="fas fa-lightbulb me-1"></i>
                            M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ nh·ªØng g√¨ b·∫°n mu·ªën t·∫°o ·∫£nh
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" id="clearBtn">
                            <i class="fas fa-eraser me-1"></i>X√≥a
                        </button>
                        <button type="submit" class="btn btn-success" id="generateBtn">
                            <i class="fas fa-magic me-1"></i>T·∫°o prompt
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>
    
    <div class="col-md-6">
        <!-- Prompt g·∫ßn ƒë√¢y -->
        <div class="card border-0 shadow-sm">
            <div class="recent-prompts-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>Prompt g·∫ßn ƒë√¢y (B·∫•m ch·ªânh s·ª≠a ƒë·ªÉ xem chi ti·∫øt)
                </h6>
                <button class="refresh-btn" onclick="loadRecentPrompts()" title="L√†m m·ªõi">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="prompts-container" id="recentPrompts">
                <div class="loading-prompts">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div class="mt-2">ƒêang t·∫£i prompts...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <!-- K·∫øt qu·∫£ prompt -->
        <div class="card" id="resultCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-text me-2"></i>Prompt ƒë√£ t·∫°o
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Ch·ªß ƒë·ªÅ:</label>
                    <div id="resultTopic" class="form-control-plaintext fw-bold"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Prompt ·∫£nh (ti·∫øng Anh):</label>
                    <div class="position-relative">
                        <textarea 
                            id="resultPrompt" 
                            class="form-control" 
                            rows="4" 
                            readonly></textarea>
                        <button 
                            type="button" 
                            class="btn btn-outline-primary btn-sm position-absolute top-0 end-0 m-2" 
                            id="copyBtn"
                            title="Sao ch√©p prompt ·∫£nh">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                

                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="usePromptBtn">
                        <i class="fas fa-image me-1"></i>T·∫°o ·∫£nh v·ªõi prompt n√†y
                    </button>
                    <button type="button" class="btn btn-outline-success" id="savePromptBtn">
                        <i class="fas fa-save me-1"></i>ƒê√£ l∆∞u
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Tr·∫°ng th√°i -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Tr·∫°ng th√°i
                </h5>
            </div>
            <div class="card-body">
                <div id="statusSection" style="display: none;">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Ti·∫øn tr√¨nh</small>
                            <small class="text-muted" id="progressText">0%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info" id="statusMessage">
                        <i class="fas fa-spinner fa-spin me-2"></i>ƒêang kh·ªüi t·∫°o AI...
                    </div>
                </div>
                
                <!-- H∆∞·ªõng d·∫´n -->
                <div id="instructionSection">
                    <h6>H∆∞·ªõng d·∫´n:</h6>
                    <ol class="small">
                        <li>Nh·∫≠p ch·ªß ƒë·ªÅ b·∫±ng ti·∫øng Vi·ªát</li>
                        <li>Nh·∫•n "T·∫°o prompt" v√† ch·ªù AI x·ª≠ l√Ω</li>
                        <li>AI s·∫Ω sinh prompt ti·∫øng Anh chi ti·∫øt</li>
                        <li>S·ª≠ d·ª•ng prompt ƒë·ªÉ t·∫°o ·∫£nh</li>
                    </ol>
                    
                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            ƒê·∫£m b·∫£o ƒë√£ c·∫•u h√¨nh API key Gemini trong m·ª•c C√†i ƒë·∫∑t
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- V√≠ d·ª• ch·ªß ƒë·ªÅ -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>V√≠ d·ª• ch·ªß ƒë·ªÅ
                </h6>
            </div>
            <div class="card-body">
                <div class="topic-examples">
                    <div class="mb-2">
                        <button class="btn btn-outline-success btn-sm w-100 text-start example-btn" 
                                data-topic="con m√®o d·ªÖ th∆∞∆°ng">
                            Con m√®o d·ªÖ th∆∞∆°ng
                        </button>
                    </div>
                    <div class="mb-2">
                        <button class="btn btn-outline-success btn-sm w-100 text-start example-btn" 
                                data-topic="phong c·∫£nh ho√†ng h√¥n">
                            Phong c·∫£nh ho√†ng h√¥n
                        </button>
                    </div>
                    <div class="mb-2">
                        <button class="btn btn-outline-success btn-sm w-100 text-start example-btn" 
                                data-topic="robot futuristic">
                            Robot futuristic
                        </button>
                    </div>
                    <div class="mb-2">
                        <button class="btn btn-outline-success btn-sm w-100 text-start example-btn" 
                                data-topic="ph√≤ng kh√°ch hi·ªán ƒë·∫°i">
                            Ph√≤ng kh√°ch hi·ªán ƒë·∫°i
                        </button>
                    </div>
                </div>
            </div>
        </div>
        

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTaskId = null;
    let statusCheckInterval = null;
    let currentPromptData = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('promptForm');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const copyBtn = document.getElementById('copyBtn');
        const usePromptBtn = document.getElementById('usePromptBtn');
        const exampleBtns = document.querySelectorAll('.example-btn');
        
        // Load recent prompts immediately (no auto-refresh)
        loadRecentPrompts();
        
        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            generatePrompt();
        });
        
        // Handle clear button
        clearBtn.addEventListener('click', function() {
            form.reset();
            hideStatus();
            hideResult();
        });
        
        // Handle copy button for image prompt
        copyBtn.addEventListener('click', function() {
            const promptText = document.getElementById('resultPrompt');
            promptText.select();
            document.execCommand('copy');
            
            // Show feedback
            this.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
        });
        

        
        // Handle use prompt button
        usePromptBtn.addEventListener('click', function() {
            const prompt = document.getElementById('resultPrompt').value;
            // Redirect to image generation page with prompt
            const url = new URL('/generate-image', window.location.origin);
            url.searchParams.set('prompt', prompt);
            window.open(url.toString(), '_blank');
        });
        
        // Handle example topics
        exampleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('topic').value = this.dataset.topic;
            });
        });
    });
    
    function generatePrompt() {
        const topic = document.getElementById('topic').value.trim();
        
        if (!topic) {
            alert('Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ!');
            return;
        }
        
        // Show loading state
        showStatus();
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('generateBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫°o...';
        
        // Start prompt generation
        fetch('/api/generate-prompt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ topic: topic })
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                throw new Error(result.error);
            }
            
            currentTaskId = result.task_id;
            checkTaskStatus();
        })
        .catch(error => {
            console.error('Error:', error);
            showError(error.message);
            resetForm();
        });
    }
    
    function checkTaskStatus() {
        if (!currentTaskId) return;
        
        statusCheckInterval = setInterval(() => {
            fetch(`/api/task-status/${currentTaskId}`)
                .then(response => response.json())
                .then(status => {
                    updateProgress(status.progress || 0, status.message || 'ƒêang x·ª≠ l√Ω...');
                    
                    if (status.status === 'completed') {
                        clearInterval(statusCheckInterval);
                        showResult(status.results[0], status.filename);
                        resetForm();
                    } else if (status.status === 'error') {
                        clearInterval(statusCheckInterval);
                        showError(status.message || 'C√≥ l·ªói x·∫£y ra');
                        resetForm();
                    }
                })
                .catch(error => {
                    console.error('Status check error:', error);
                });
        }, 2000);
    }
    
    function showStatus() {
        document.getElementById('instructionSection').style.display = 'none';
        document.getElementById('statusSection').style.display = 'block';
    }
    
    function hideStatus() {
        document.getElementById('instructionSection').style.display = 'block';
        document.getElementById('statusSection').style.display = 'none';
    }
    
    function showResult(promptData, filename) {
        currentPromptData = promptData;
        
        document.getElementById('resultTopic').textContent = promptData.topic || '';
        document.getElementById('resultPrompt').value = promptData.image_prompt || '';

        document.getElementById('resultCard').style.display = 'block';
        
        // Update status message
        document.getElementById('statusMessage').innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>Ho√†n th√†nh! Prompt ƒë√£ ƒë∆∞·ª£c t·∫°o v√† l∆∞u`;
        
        // Show countdown and reload prompts after 4 seconds
        let countdown = 4;
        const countdownInterval = setInterval(() => {
            document.getElementById('statusMessage').innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>Ho√†n th√†nh! ƒêang c·∫≠p nh·∫≠t danh s√°ch prompts... (${countdown}s)`;
            countdown--;
            
            if (countdown < 0) {
                clearInterval(countdownInterval);
                loadRecentPrompts();
                document.getElementById('statusMessage').innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>Ho√†n th√†nh! Prompt ƒë√£ ƒë∆∞·ª£c t·∫°o v√† l∆∞u`;
            }
        }, 1000);
    }
    
    function hideResult() {
        document.getElementById('resultCard').style.display = 'none';
        currentPromptData = null;
    }
    
    function updateProgress(progress, message) {
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = progress + '%';
        document.getElementById('statusMessage').innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${message}`;
    }
    
    function showError(message) {
        document.getElementById('statusMessage').innerHTML = `<i class="fas fa-exclamation-circle text-danger me-2"></i>L·ªói: ${message}`;
        document.getElementById('statusMessage').className = 'alert alert-danger';
    }
    
    function resetForm() {
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').innerHTML = '<i class="fas fa-magic me-1"></i>T·∫°o prompt';
        currentTaskId = null;
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }
    }
    
    function loadRecentPrompts() {
        console.log('Loading recent prompts...');
        const container = document.getElementById('recentPrompts');
        container.innerHTML = `
            <div class="loading-prompts">
                <i class="fas fa-spinner fa-spin"></i>
                <div class="mt-2">ƒêang t·∫£i prompts...</div>
            </div>
        `;
        
        fetch('/api/prompts')
            .then(r => r.json())
            .then(prompts => {
                console.log('Received prompts:', prompts);
                currentPrompts = prompts.slice(0, 5); // Store for global access
                const container = document.getElementById('recentPrompts');
                container.innerHTML = '';
                
                currentPrompts.forEach((prompt, index) => {
                    const displayText = prompt.content || prompt.image_prompt || 'Kh√¥ng c√≥ n·ªôi dung';
                    const div = document.createElement('div');
                    div.className = 'prompt-card p-3';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1" onclick="loadPromptToEditor(${index})">
                                <div class="prompt-topic">${prompt.topic || 'Kh√¥ng c√≥ ch·ªß ƒë·ªÅ'}</div>
                                <div class="prompt-text">${displayText}</div>
                                <div class="prompt-meta">
                                    <span><i class="fas fa-clock me-1"></i>${prompt.created}</span>
                                    <span><i class="fas fa-file-alt me-1"></i>${prompt.filename || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="prompt-actions ms-2">
                                <button class="action-btn btn-edit" onclick="editPromptInline(${index})" title="Ch·ªânh s·ª≠a">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-copy" onclick="copyPromptText(${index})" title="Copy">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="action-btn btn-use" onclick="loadPromptToEditor(${index})" title="S·ª≠ d·ª•ng">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Store prompt data in div for later access
                    div.promptData = prompt;
                    div.promptIndex = index;
                    
                    container.appendChild(div);
                });
                
                if (prompts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-prompts">
                            <i class="fas fa-file-text"></i>
                            <div><strong>Ch∆∞a c√≥ prompt n√†o</strong></div>
                            <small>T·∫°o prompt ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu!</small>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading prompts:', error);
                const container = document.getElementById('recentPrompts');
                container.innerHTML = `
                    <div class="empty-prompts">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                        <div><strong>L·ªói t·∫£i prompts</strong></div>
                        <small>${error.message}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRecentPrompts()">
                                <i class="fas fa-redo me-1"></i>Th·ª≠ l·∫°i
                            </button>
                        </div>
                    </div>
                `;
            });
    }
    
    // Global variable to store current prompts for access in onclick functions
    let currentPrompts = [];
    
    function loadPromptToEditor(index) {
        const prompt = currentPrompts[index];
        if (!prompt) return;
        
        document.getElementById('resultTopic').textContent = prompt.topic || '';
        document.getElementById('resultPrompt').value = prompt.content || prompt.image_prompt || '';

        document.getElementById('resultCard').style.display = 'block';
        currentPromptData = prompt;
    }
    
    function copyPromptText(index) {
        const prompt = currentPrompts[index];
        if (!prompt) return;
        
        const textToCopy = prompt.content || prompt.image_prompt || '';
        
        // Create temporary textarea to copy text
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        
        // Show feedback
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check text-success"></i>';
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 2000);
    }
    
    function editPromptInline(index) {
        const prompt = currentPrompts[index];
        if (!prompt) return;
        
        const container = document.getElementById('recentPrompts');
        const promptDiv = container.children[index];
        
        if (!promptDiv) return;
        
        // Create edit form
        const originalContent = promptDiv.innerHTML;
        const imagePrompt = prompt.content || prompt.image_prompt || '';
        
        promptDiv.innerHTML = `
            <div class="edit-form">
                <div class="mb-2">
                    <label class="form-label small"><strong>Ch·ªß ƒë·ªÅ:</strong></label>
                    <input type="text" class="form-control form-control-sm" value="${prompt.topic || ''}" id="editTopic_${index}">
                </div>
                <div class="mb-2">
                    <label class="form-label small"><strong>Prompt ·∫£nh:</strong></label>
                    <textarea class="form-control form-control-sm" rows="3" id="editImagePrompt_${index}">${imagePrompt}</textarea>
                </div>
                <div class="edit-actions">
                    <button class="btn btn-success" onclick="savePromptEdit(${index})">
                        <i class="fas fa-save me-1"></i>L∆∞u
                    </button>
                    <button class="btn btn-secondary" onclick="cancelPromptEdit(${index})">
                        <i class="fas fa-times me-1"></i>H·ªßy
                    </button>
                    <button class="btn btn-primary" onclick="useEditedPrompt(${index})">
                        <i class="fas fa-arrow-right me-1"></i>D√πng ngay
                    </button>
                </div>
            </div>
        `;
        
        // Store original content for cancel
        promptDiv.originalContent = originalContent;
    }
    
    function cancelPromptEdit(index) {
        const container = document.getElementById('recentPrompts');
        const promptDiv = container.children[index];
        
        if (promptDiv && promptDiv.originalContent) {
            promptDiv.innerHTML = promptDiv.originalContent;
            delete promptDiv.originalContent;
        }
    }
    
    function useEditedPrompt(index) {
        const newTopic = document.getElementById(`editTopic_${index}`).value;
        const newImagePrompt = document.getElementById(`editImagePrompt_${index}`).value;
        
        // Load to result editor
        document.getElementById('resultTopic').textContent = newTopic;
        document.getElementById('resultPrompt').value = newImagePrompt;
        document.getElementById('resultCard').style.display = 'block';
        
        // Cancel edit mode
        cancelPromptEdit(index);
    }
    
    function savePromptEdit(index) {
        const prompt = currentPrompts[index];
        if (!prompt) return;
        
        const newTopic = document.getElementById(`editTopic_${index}`).value;
        const newImagePrompt = document.getElementById(`editImagePrompt_${index}`).value;
        
        // Update the prompt data
        const updatedPrompt = {
            ...prompt,
            topic: newTopic,
            image_prompt: newImagePrompt,
            content: newImagePrompt // Keep both for compatibility
        };
        
        // Save to file via API (you could implement this)
        fetch('/api/update-prompt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                filename: prompt.filename,
                data: updatedPrompt
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Update local data
                currentPrompts[index] = updatedPrompt;
                
                // Refresh display
                loadRecentPrompts();
                
                alert('ƒê√£ l∆∞u th√†nh c√¥ng!');
            } else {
                alert('L·ªói l∆∞u: ' + (result.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            alert('L·ªói l∆∞u prompt: ' + error.message);
        });
    }
    
    // Check for prompt parameter in URL
    const urlParams = new URLSearchParams(window.location.search);
    const promptParam = urlParams.get('prompt');
    if (promptParam) {
        document.getElementById('resultPrompt').value = promptParam;
        document.getElementById('resultCard').style.display = 'block';
    }
</script>
{% endblock %}